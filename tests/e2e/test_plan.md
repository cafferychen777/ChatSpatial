# ChatSpatial MCP Server - End-to-End Test Plan

## 测试目标
验证ChatSpatial MCP服务器在真实环境中的功能完整性、用户体验和与客户端的集成。

## 测试环境
- **MCP Inspector**: 用于直接协议测试
- **Claude Desktop**: 用于真实用户场景测试
- **测试数据**: 标准化的空间转录组学数据集

---

## 测试用例清单

### E2E-001: 基础工作流测试
**目标**: 验证标准分析工作流的完整性

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 1 | 启动MCP Inspector | 服务器成功连接，工具列表显示 | ⬜ |
| 2 | 调用`load_data`加载visium数据 | 返回成功消息和数据ID | ⬜ |
| 3 | 调用`preprocess_data`进行预处理 | 返回预处理完成消息 | ⬜ |
| 4 | 调用`visualize_data`创建空间图 | 返回有效的PNG图像 | ⬜ |
| 5 | 验证图像质量 | 图像清晰，包含空间坐标和基因表达 | ⬜ |

**成功标准**: 所有步骤成功执行，最终图像质量符合预期

---

### E2E-002: Claude Desktop集成测试
**目标**: 验证与Claude Desktop的无缝集成

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 1 | 配置Claude Desktop MCP设置 | 工具图标在界面中显示 | ⬜ |
| 2 | 重启Claude Desktop | 成功加载ChatSpatial工具 | ⬜ |
| 3 | 发送消息: "加载visium数据并展示Gad1基因的空间表达图" | Claude理解请求并调用相应工具 | ⬜ |
| 4 | 验证工具调用序列 | 正确调用load_data → visualize_data | ⬜ |
| 5 | 检查最终结果 | 聊天窗口显示Gad1基因空间表达图 | ⬜ |

**成功标准**: Claude能够理解自然语言请求并正确调用工具链

---

### E2E-003: 进度报告测试
**目标**: 验证长时间运行任务的进度报告功能

| 步骤 | 操作 | 预期结果 | 状态 |
|------|------|----------|------|
| 1 | 启动MCP Inspector | 服务器连接成功 | ⬜ |
| 2 | 调用耗时工具（如`identify_spatial_domains`）并提供progressToken | 任务开始执行 | ⬜ |
| 3 | 观察Notifications面板 | 实时显示进度更新 | ⬜ |
| 4 | 等待任务完成 | 收到完成通知和最终结果 | ⬜ |
| 5 | 验证结果正确性 | 空间域识别结果符合预期 | ⬜ |

**成功标准**: 进度报告准确，用户体验良好

---

### E2E-004: 错误处理测试
**目标**: 验证各种错误情况的处理

| 测试场景 | 操作 | 预期结果 | 状态 |
|----------|------|----------|------|
| 无效数据ID | 请求不存在的数据集 | 返回清晰的错误信息 | ⬜ |
| 无效基因名 | 请求不存在的基因可视化 | 优雅处理，提供替代方案或警告 | ⬜ |
| 缺失数据 | 在未预处理的数据上请求UMAP | 自动预处理或提供明确指导 | ⬜ |
| 参数错误 | 提供无效的plot_type | 返回参数验证错误 | ⬜ |
| 内存不足 | 处理超大数据集 | 优雅降级或内存管理 | ⬜ |

**成功标准**: 所有错误情况都有适当的错误信息和恢复建议

---

### E2E-005: 增强功能测试
**目标**: 验证新增的增强功能

| 功能 | 测试操作 | 预期结果 | 状态 |
|------|----------|----------|------|
| 空间轮廓叠加 | 请求带轮廓的空间图 | 图像显示cluster边界轮廓 | ⬜ |
| UMAP双重编码 | 请求颜色+大小编码的UMAP | 点的颜色和大小都有意义 | ⬜ |
| 空间交互可视化 | 请求配体-受体对可视化 | 显示LR对的空间分布 | ⬜ |
| 增强热图 | 请求带注释的热图 | 显示行列注释信息 | ⬜ |
| 整合评估 | 请求批次效应评估 | 多面板显示整合质量 | ⬜ |
| 网络可视化 | 请求邻域富集网络图 | 显示network layout | ⬜ |

**成功标准**: 所有新功能正常工作，图像质量符合专业标准

---

### E2E-006: 性能测试
**目标**: 验证系统在不同负载下的性能

| 测试场景 | 数据规模 | 预期响应时间 | 状态 |
|----------|----------|--------------|------|
| 小数据集 | 100细胞 | < 5秒 | ⬜ |
| 标准数据集 | 1000细胞 | < 15秒 | ⬜ |
| 大数据集 | 5000细胞 | < 60秒 | ⬜ |
| 并发请求 | 5个同时请求 | 正常处理，无崩溃 | ⬜ |
| 内存使用 | 连续10次可视化 | 内存增长控制在合理范围 | ⬜ |

**成功标准**: 响应时间满足用户预期，系统稳定运行

---

### E2E-007: 兼容性测试
**目标**: 验证不同环境下的兼容性

| 环境 | 测试内容 | 预期结果 | 状态 |
|------|----------|----------|------|
| macOS | 完整功能测试 | 所有功能正常 | ⬜ |
| Linux | 完整功能测试 | 所有功能正常 | ⬜ |
| Windows | 完整功能测试 | 所有功能正常 | ⬜ |
| Python 3.9 | 基础功能测试 | 正常运行 | ⬜ |
| Python 3.10 | 基础功能测试 | 正常运行 | ⬜ |
| Python 3.11 | 基础功能测试 | 正常运行 | ⬜ |

**成功标准**: 在主流操作系统和Python版本上稳定运行

---

## 执行指南

### 测试前准备
1. **环境设置**
   ```bash
   # 安装测试依赖
   pip install pytest pytest-asyncio pytest-cov
   
   # 安装MCP Inspector
   npm install -g @modelcontextprotocol/inspector
   
   # 准备测试数据
   python scripts/prepare_test_data.py
   ```

2. **服务器启动**
   ```bash
   # 启动MCP Inspector
   npx @modelcontextprotocol/inspector python -m chatspatial
   
   # 或启动服务器用于Claude Desktop
   python -m chatspatial
   ```

### 测试执行
1. **手动测试**: 按照测试用例清单逐项执行
2. **自动化测试**: 运行端到端自动化脚本
3. **记录结果**: 在状态列标记✅（通过）或❌（失败）
4. **问题记录**: 详细记录发现的问题和解决方案

### 测试报告
每次测试完成后，生成包含以下内容的测试报告：
- 测试执行日期和环境信息
- 各测试用例的详细结果
- 发现的问题和解决状态
- 性能数据和趋势分析
- 改进建议

### 测试频率
- **完整E2E测试**: 每次主要版本发布前
- **核心功能测试**: 每次功能更新后
- **回归测试**: 每周定期执行
- **性能测试**: 每月执行一次

---

## 成功标准

### 整体成功标准
- ✅ 95%以上的测试用例通过
- ✅ 关键工作流程100%成功
- ✅ 错误处理覆盖所有已知场景
- ✅ 性能指标满足用户预期
- ✅ 用户体验流畅自然

### 质量门禁
- 🚫 发现严重功能缺陷 → 阻止发布
- ⚠️  发现轻微问题 → 记录并排期修复
- 📊 性能不达标 → 优化后重测
- 🐛 新发现Bug → 增加对应测试用例

通过这个全面的E2E测试计划，确保ChatSpatial MCP服务器在各种真实场景下都能提供高质量、可靠的服务体验。