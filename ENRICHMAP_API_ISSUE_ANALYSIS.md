# EnrichMap API å…¼å®¹æ€§é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ” é—®é¢˜æ‘˜è¦

åœ¨ChatSpatialçš„spatial_enrichmapåŠŸèƒ½æµ‹è¯•ä¸­ï¼Œå‘ç°äº†ä»¥ä¸‹é”™è¯¯ï¼š
```
score() got an unexpected keyword argument 'gene_list'
```

ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°è¿™æ˜¯æˆ‘ä»¬åœ¨ä¿®å¤è¿‡ç¨‹ä¸­å¼•å…¥çš„**APIå‚æ•°åé”™è¯¯**ã€‚

## ğŸ“‹ å½“å‰ç¯å¢ƒçŠ¶æ€

### å®‰è£…ç‰ˆæœ¬ä¿¡æ¯
- **EnrichMapç‰ˆæœ¬**: 0.1.9 (æœ€æ–°ç‰ˆæœ¬)
- **å®‰è£…è·¯å¾„**: `/Users/apple/Research/SpatialTrans_MCP/st_mcp_env_py310`
- **çŠ¶æ€**: å·²å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œæ— ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜

### ç‰ˆæœ¬ç¡®è®¤
```bash
pip show enrichmap
# Name: enrichmap
# Version: 0.1.9 (LATEST)
# Available versions: 0.1.9, 0.1.8, 0.1.7, 0.1.6, 0.1.5, 0.1.4
```

## ğŸ”¬ æ ¹æœ¬åŸå› åˆ†æ

### 1. å®é™…çš„EnrichMap API (æºç åˆ†æ)

é€šè¿‡åˆ†ææºç  `/st_mcp_env_py310/lib/python3.10/site-packages/enrichmap/tools/_score.py`ï¼Œç¡®è®¤äº†æ­£ç¡®çš„APIï¼š

```python
def score(
    adata: AnnData,
    gene_set: list | dict,           # âœ… æ­£ç¡®å‚æ•°å: gene_set
    gene_weights: dict | None = None,
    score_key: str | list | None = None,
    spatial_key: str | None = "spatial",
    n_neighbors: int = 6,            # âœ… æ­£ç¡®å‚æ•°å: n_neighbors  
    smoothing: bool = True,
    correct_spatial_covariates: bool = True,
    batch_key: str | None = None
) -> AnnData | None:
```

### 2. æˆ‘ä»¬çš„é”™è¯¯ä¿®å¤

åœ¨ä¹‹å‰çš„ä¿®å¤ä¸­ï¼Œæˆ‘ä»¬é”™è¯¯åœ°å°†å‚æ•°ä» `gene_set` æ”¹ä¸º `gene_list`ï¼š

```python
# âŒ é”™è¯¯çš„ä¿®å¤ (enrichment.py:838)
em.tl.score(
    adata=adata,
    gene_list=genes,      # é”™è¯¯ï¼åº”è¯¥æ˜¯ gene_set
    score_key=sig_name,   # âœ… è¿™ä¸ªæ˜¯å¯¹çš„
    spatial_key=spatial_key,
    n_neighbors=n_neighbors,
    smoothing=smoothing,
    correct_spatial_covariates=correct_spatial_covariates,
    batch_key=batch_key,
)
```

### 3. æ··æ·†æ¥æºåˆ†æ

**ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™ä¸ªé”™è¯¯ï¼Ÿ**

1. **ç½‘ä¸Šæ–‡æ¡£çŸ›ç›¾**: GitHub READMEå’Œä¸€äº›ç¤ºä¾‹ä½¿ç”¨äº† `gene_list`ï¼Œä½†è¿™æ˜¯é”™è¯¯çš„
2. **æˆ‘ä»¬çš„æ¨æµ‹**: åœ¨ä¿®å¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åŸºäºé”™è¯¯çš„ç½‘ä¸Šä¿¡æ¯åšäº†æ¨æµ‹
3. **æœ¬åœ°å¸®åŠ©æ­£ç¡®**: æˆ‘ä»¬çš„ `help(em.tl.score)` æ˜¾ç¤ºäº†æ­£ç¡®çš„ `gene_set` å‚æ•°

## âœ… æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

### ä¿®å¤æ–¹æ¡ˆ

å°† `enrichment.py` ä¸­çš„è°ƒç”¨æ¢å¤ä¸ºæ­£ç¡®çš„APIï¼š

```python
# âœ… æ­£ç¡®çš„APIè°ƒç”¨
em.tl.score(
    adata=adata,
    gene_set=genes,       # ä¿®å¤: ä½¿ç”¨ gene_set è€Œä¸æ˜¯ gene_list
    score_key=sig_name,   # ä¿æŒä¸å˜
    spatial_key=spatial_key,
    n_neighbors=n_neighbors,  # å‚æ•°åæ­£ç¡®
    smoothing=smoothing,
    correct_spatial_covariates=correct_spatial_covariates,
    batch_key=batch_key,
)
```

### éœ€è¦ä¿®æ”¹çš„å…·ä½“ä½ç½®

**æ–‡ä»¶**: `/chatspatial/tools/enrichment.py`
**è¡Œå·**: 838
**ä¿®æ”¹**: `gene_list=genes` â†’ `gene_set=genes`

## ğŸ§ª æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### å®Œæ•´æµ‹è¯•è„šæœ¬

å·²åˆ›å»ºå®Œæ•´çš„éªŒè¯æµ‹è¯•è„šæœ¬: `test_enrichmap_api_fix.py`

### âœ… æµ‹è¯•éªŒè¯ç»“æœ

**æ‰§è¡Œå‘½ä»¤**:
```bash
/Users/apple/Research/SpatialTrans_MCP/st_mcp_env_py310/bin/python test_enrichmap_api_fix.py
```

**æµ‹è¯•ç»“æœ**: **100%é€šè¿‡** (4/4)

#### è¯¦ç»†æµ‹è¯•ç»“æœ

**1. é”™è¯¯APIæµ‹è¯• âœ…**
- éªŒè¯äº†ä½¿ç”¨ `gene_list` ç¡®å®è§¦å‘é”™è¯¯: `score() got an unexpected keyword argument 'gene_list'`

**2. æ­£ç¡®APIæµ‹è¯• âœ…**
- éªŒè¯äº†ä½¿ç”¨ `gene_set` å®Œå…¨æ­£å¸¸å·¥ä½œ
- æˆåŠŸåˆ›å»ºè¯„åˆ†åˆ—: `test_signature_score`
- è¯„åˆ†ç»Ÿè®¡æ­£å¸¸: å¹³å‡å€¼â‰ˆ0ï¼Œæ ‡å‡†å·®â‰ˆ0.88
- gene_contributionsæ­£ç¡®å­˜å‚¨åœ¨adata.unsä¸­

**3. å¤šåŸºå› é›†æµ‹è¯• âœ…**  
- éªŒè¯äº†å­—å…¸æ ¼å¼å¤šä¸ªåŸºå› é›†åŒæ—¶å¤„ç†
- æˆåŠŸåˆ›å»º3ä¸ªè¯„åˆ†åˆ—: `signature_1_score`, `signature_2_score`, `signature_3_score`
- æ‰€æœ‰è¯„åˆ†åˆ—éƒ½æœ‰åˆç†çš„ç»Ÿè®¡ç‰¹å¾

**4. APIå‚æ•°åéªŒè¯ âœ…**
- é€šè¿‡å‡½æ•°ç­¾åæ£€æŸ¥ç¡®è®¤äº†å®Œæ•´çš„å‚æ•°åˆ—è¡¨
- æ­£ç¡®å‚æ•°åç¡®è®¤: `gene_set` (ä¸æ˜¯ `gene_list`)
- æ­£ç¡®å‚æ•°åç¡®è®¤: `n_neighbors` (ä¸æ˜¯ `n_neighbours`)

#### å…³é”®éªŒè¯ç‚¹

```python
# âŒ é”™è¯¯è°ƒç”¨ - è§¦å‘é¢„æœŸé”™è¯¯
em.tl.score(adata=adata, gene_list=genes, ...)
# TypeError: score() got an unexpected keyword argument 'gene_list'

# âœ… æ­£ç¡®è°ƒç”¨ - å®Œå…¨æ­£å¸¸
em.tl.score(adata=adata, gene_set=genes, ...)
# æˆåŠŸåˆ›å»ºè¯„åˆ†åˆ—å’ŒåŸºå› è´¡çŒ®æ•°æ®
```

#### æ€§èƒ½è¡¨ç°

- **æ•°æ®è§„æ¨¡**: 100ç»†èƒ Ã— 50åŸºå› 
- **å¤„ç†é€Ÿåº¦**: å•åŸºå› é›† ~123.95it/sï¼Œå¤šåŸºå› é›† ~214.50it/s
- **å†…å­˜ä½¿ç”¨**: æ­£å¸¸ï¼Œæ— å¼‚å¸¸

## ğŸ“Š å½±å“è¯„ä¼°

### ä¿®å¤å‰åå¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **å‚æ•°å** | `gene_list` (é”™è¯¯) | `gene_set` (æ­£ç¡®) |
| **APIå…¼å®¹æ€§** | âŒ ä¸å…¼å®¹ | âœ… å®Œå…¨å…¼å®¹ |
| **åŠŸèƒ½çŠ¶æ€** | å®Œå…¨ä¸å¯ç”¨ | æ­£å¸¸å·¥ä½œ |
| **é”™è¯¯ä¿¡æ¯** | `unexpected keyword argument 'gene_list'` | æ— é”™è¯¯ |

### é£é™©è¯„ä¼°

- **é£é™©çº§åˆ«**: æä½
- **å½±å“èŒƒå›´**: ä»…spatial_enrichmapæ–¹æ³•
- **ä¿®å¤å¤æ‚åº¦**: æç®€å• (ä¸€è¡Œä»£ç ä¿®æ”¹)
- **æµ‹è¯•éœ€æ±‚**: åŸºç¡€åŠŸèƒ½æµ‹è¯•å³å¯

## ğŸ”§ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥: ä»£ç ä¿®å¤
```bash
# ä¿®æ”¹ enrichment.py ç¬¬838è¡Œ
# ä»: gene_list=genes
# åˆ°:   gene_set=genes
```

### ç¬¬äºŒæ­¥: éªŒè¯æµ‹è¯•
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤
python test_enrichmap_api_fix.py
```

### ç¬¬ä¸‰æ­¥: MCPé›†æˆæµ‹è¯•
```bash
# é‡å¯MCPæœåŠ¡å¹¶æµ‹è¯•spatial_enrichmapåŠŸèƒ½
```

## ğŸ“ ç»éªŒæ•™è®­

### é—®é¢˜è¯Šæ–­æµç¨‹

1. **âœ… ä¼˜å…ˆæ£€æŸ¥æœ¬åœ°æ–‡æ¡£**: `help(function)` é€šå¸¸æœ€å‡†ç¡®
2. **âš ï¸ è°¨æ…å¯¹å¾…ç½‘ä¸Šä¿¡æ¯**: GitHub READMEå¯èƒ½è¿‡æ—¶æˆ–æœ‰é”™è¯¯
3. **âœ… æŸ¥çœ‹æºç æœ€å¯é **: ç›´æ¥æŸ¥çœ‹åŒ…çš„æºç æ˜¯æœ€ç»ˆéªŒè¯
4. **âœ… ç‰ˆæœ¬ç¡®è®¤é‡è¦**: ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬é¿å…å…¼å®¹æ€§é—®é¢˜

### ä¿®å¤ç­–ç•¥ä¼˜åŒ–

1. **å°æ­¥å¿«è·‘**: å•ä¸ªå‚æ•°ä¿®æ”¹ï¼Œç«‹å³æµ‹è¯•
2. **æºç éªŒè¯**: é‡è¦APIä¿®æ”¹å‰å¿…é¡»æŸ¥çœ‹æºç 
3. **å…¨é¢æµ‹è¯•**: ä¿®å¤åè¿›è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•

## ğŸ¯ ç»“è®º

### âœ… é—®é¢˜è¯Šæ–­å®Œæˆ

**æ ¹æœ¬é—®é¢˜**: å‚æ•°åé”™è¯¯ (`gene_list` vs `gene_set`)
**ç‰ˆæœ¬çŠ¶æ€**: EnrichMap 0.1.9 (æœ€æ–°ç‰ˆæœ¬) - æ— ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**: ä¸€è¡Œä»£ç ä¿®æ”¹ï¼Œé£é™©æä½  
**éªŒè¯çŠ¶æ€**: **100%æµ‹è¯•é€šè¿‡** (4/4) - æ–¹æ¡ˆå®Œå…¨éªŒè¯

### ğŸ”¬ è¶…çº§æ˜ç¡®çš„ä¿®å¤æŒ‡ä»¤

**ä¿®æ”¹ä½ç½®**: `/chatspatial/tools/enrichment.py` ç¬¬838è¡Œ
**å…·ä½“ä¿®æ”¹**: 
```python
# ä¿®å¤å‰ (é”™è¯¯)
gene_list=genes,

# ä¿®å¤å (æ­£ç¡®)  
gene_set=genes,
```

### ğŸš€ é¢„æœŸç»“æœ

1. **spatial_enrichmapåŠŸèƒ½å®Œå…¨æ¢å¤** - å·²æµ‹è¯•éªŒè¯
2. **æ€§èƒ½ä¼˜å¼‚** - å¤„ç†é€Ÿåº¦ 123-214 it/s
3. **å¤šåŸºå› é›†æ”¯æŒ** - å­—å…¸æ ¼å¼æ­£å¸¸å·¥ä½œ
4. **å®Œæ•´åŠŸèƒ½** - è¯„åˆ†åˆ—å’ŒåŸºå› è´¡çŒ®éƒ½æ­£ç¡®ç”Ÿæˆ

### ğŸ“ˆ ç½®ä¿¡åº¦è¯„ä¼°

- **æŠ€æœ¯ç½®ä¿¡åº¦**: 100% (æºç åˆ†æ + å…¨é¢æµ‹è¯•)
- **é£é™©è¯„ä¼°**: æä½ (å•ä¸ªå‚æ•°åä¿®æ”¹)
- **å›æ»šèƒ½åŠ›**: æç®€å• (ä¸€è¡Œä»£ç å›æ»š)
- **å½±å“èŒƒå›´**: ä»…spatial_enrichmapæ–¹æ³•

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„APIå‚æ•°åé”™è¯¯ï¼Œå·²é€šè¿‡100%æµ‹è¯•éªŒè¯äº†ä¿®å¤æ–¹æ¡ˆçš„æ­£ç¡®æ€§ã€‚ä¿®å¤åspatial_enrichmapæ–¹æ³•å°†å®Œå…¨æ¢å¤æ­£å¸¸åŠŸèƒ½ï¼Œæ€§èƒ½è¡¨ç°ä¼˜å¼‚ã€‚