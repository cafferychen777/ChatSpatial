# MCP (Model Context Protocol) 开发核心领域知识

本文档总结了从 `llms-full.txt` 中提取的关于 MCP 开发的核心领域知识，旨在帮助开发团队保持方向一致。

---

## 1. 核心概念与架构

### 1.1. MCP 是什么？
MCP (Model Context Protocol) 是一个开放协议，旨在为 AI 应用（特别是大型语言模型 LLM）提供一个标准化的方式来连接和使用外部的上下文信息、数据源和工具。

可以将其理解为 **AI 应用的 "USB-C" 端口**：一个统一的接口，用于连接各种外部能力，而无需为每个应用和工具进行定制化集成。

### 1.2. 核心参与者 (Client-Server 架构)
MCP 遵循客户端-服务器架构：

- **MCP Host (主机)**: 指的是 AI 应用程序本身，例如 Claude Code, VS Code 等。主机负责管理一个或多个 MCP 客户端。
- **MCP Client (客户端)**: 主机为每一个连接的 MCP 服务器创建一个客户端实例。客户端与其对应的服务器保持一对一的连接。
- **MCP Server (服务器)**: 提供上下文信息（如工具、数据资源）的程序。服务器可以本地运行（例如，访问本地文件系统），也可以远程运行（例如，连接到 Sentry 或其他云服务）。

### 1.3. 双层架构
MCP 协议分为两层：

- **Data Layer (数据层)**:
    - 定义了客户端和服务器之间基于 **JSON-RPC 2.0** 的通信协议。
    - 负责生命周期管理（连接初始化、能力协商、关闭连接）。
    - 定义了核心的**原语 (Primitives)**，如 `Tools`, `Resources`, `Prompts` 等。
- **Transport Layer (传输层)**:
    - 定义了数据交换的通信机制和通道。
    - 负责连接的建立、消息的帧定界和授权。
    - 支持两种传输机制：
        - **Stdio**: 用于本地进程间通信，性能高。
        - **Streamable HTTP**: 用于远程服务器通信，支持标准的 HTTP 认证方法。

---

## 2. 开发者核心：数据层原语 (Primitives)

这是 MCP 开发中最关键的部分，定义了客户端和服务器可以相互提供什么。

### 2.1. 服务器可暴露的原语
服务器可以将以下能力暴露给 AI 应用：

- **Tools (工具)**:
    - 可执行的函数，AI 应用可以调用它们来执行具体操作（如文件操作、API 调用、数据库查询）。
    - 客户端通过 `tools/list` 发现可用工具，通过 `tools/call` 执行工具。
- **Resources (资源)**:
    - 为 AI 应用提供上下文信息的数据源（如文件内容、数据库记录、API 响应）。
    - 客户端通过 `resources/list` 发现资源，通过 `resources/get` (或 `read`) 获取内容。
- **Prompts (提示)**:
    - 可复用的模板，用于结构化与语言模型的交互（如系统提示、少样本示例）。

### 2.2. 客户端可暴露的原语
服务器也可以请求客户端（即 AI 应用）执行操作：

- **Sampling (采样)**: 服务器可以请求客户端的 LLM 生成文本补全。这使得服务器本身无需集成 LLM SDK，保持模型无关性。
- **Elicitation (引出)**: 服务器可以向最终用户请求额外信息或操作确认。
- **Logging (日志)**: 服务器可以向客户端发送日志信息，用于调试和监控。

---

## 3. 生命周期管理

- MCP 是一个**有状态的协议**。
- 连接始于一个**握手过程**：客户端发送 `initialize` 请求，与服务器协商协议版本和双方支持的**能力 (Capabilities)**。
- 能力协商明确了双方可以使用的原语和功能（例如，服务器是否支持 `tools/list_changed` 通知）。
- 初始化成功后，客户端会发送 `notifications/initialized` 通知，表示连接就绪。

---

## 4. 治理与贡献流程

### 4.1. 治理模型
- MCP 采用分层治理结构，包括 **Contributors (贡献者)**, **Maintainers (维护者)**, **Core Maintainers (核心维护者)**, 和两名 **Lead Core Maintainers (首席核心维护者)**。
- 决策过程是透明的，旨在服务于协议本身和开源社区。

### 4.2. 贡献流程 (SEP)
- 重大功能变更需要通过 **SEP (Specification Enhancement Proposal)** 流程。
- SEP 是一个详细的设计文档，用于收集社区反馈并记录设计决策。
- 提交流程：
    1.  在 `specification` 仓库中创建 GitHub Issue，作为 SEP 草案。
    2.  寻找一名维护者作为**赞助人 (Sponsor)**。
    3.  经过社区讨论、正式审查后，最终可能被接受、拒绝或修订。
- SEP 需要包含明确的**动机 (Motivation)**、**技术规范 (Specification)**、**设计理念 (Rationale)** 和**向后兼容性**分析。

---

## 5. 开发路线图 (Roadmap 概览)

未来约六个月的开发重点包括：

- **Agents (智能体)**: 支持异步长时操作。
- **Authentication and Security (认证与安全)**: 完善安全指南，探索更优的授权机制。
- **Validation (验证)**: 提供参考实现和合规性测试套件。
- **Registry (注册中心)**: 开发用于服务发现和分发的 MCP 注册中心。
- **Multimodality (多模态)**: 增加对视频等更多媒体类型的支持。

---

**结论**: 对于 `chatspatial` 的 MCP 开发，我们应严格遵循上述核心原则。特别是：
- 在实现 `spatial_mcp_adapter.py` 时，确保正确实现了客户端的生命周期管理和能力协商。
- 在定义 `tools` 时，要使其功能明确、原子化，并提供清晰的描述。
- 考虑利用 `Resources` 来暴露空间数据分析中常用的上下文信息（如基因列表、细胞注释等）。
- 遵循 JSON-RPC 2.0 格式进行所有通信。
