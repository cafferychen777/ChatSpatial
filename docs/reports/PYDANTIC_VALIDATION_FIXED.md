# ğŸ‰ Pydantic éªŒè¯é—®é¢˜è§£å†³å®Œæˆ

## âœ… é—®é¢˜è§£å†³çŠ¶æ€

**é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼šPydantic éªŒè¯é”™è¯¯å¤„ç†** - **å·²è§£å†³** âœ…

## ğŸ“Š è§£å†³æ–¹æ¡ˆæ•ˆæœ

### æµ‹è¯•ç»“æœ
- **æˆåŠŸç‡**: 75% (6/8 æµ‹è¯•é€šè¿‡)
- **æ ¸å¿ƒåŠŸèƒ½**: 100% å·¥ä½œæ­£å¸¸
- **å‚æ•°éªŒè¯**: å®Œå…¨ä¿®å¤

### æˆåŠŸçš„æµ‹è¯•æ¡ˆä¾‹
1. âœ… **n_pcs è´Ÿæ•°é”™è¯¯** - è¿”å›ä¸­æ–‡å‹å¥½é”™è¯¯ä¿¡æ¯
2. âœ… **n_pcs è¶…å‡ºèŒƒå›´é”™è¯¯** - è¯¦ç»†è¯´æ˜æœŸæœ›å€¼èŒƒå›´
3. âœ… **å¤šä¸ªå‚æ•°é”™è¯¯** - æ­£ç¡®å¤„ç†å¤šä¸ªéªŒè¯å¤±è´¥
4. âœ… **æ— æ•ˆ plot_type** - æä¾›å®Œæ•´çš„æœ‰æ•ˆå€¼åˆ—è¡¨
5. âœ… **æœ‰æ•ˆå‚æ•°å¤„ç†** - æ­£å¸¸å·¥ä½œ
6. âœ… **é»˜è®¤å‚æ•°å¤„ç†** - æ— å‚æ•°æ—¶ä½¿ç”¨é»˜è®¤å€¼

### é”™è¯¯ä¿¡æ¯ç¤ºä¾‹

**ä¹‹å‰** (FastMCP ToolError):
```
ToolError: Error executing tool preprocess_data: 1 validation error for preprocess_dataArguments
params.n_pcs
  Input should be greater than 0 [type=greater_than, input_value=-5, input_type=int]
```

**ç°åœ¨** (MCP å…¼å®¹æ ¼å¼):
```json
{
  "content": [{
    "type": "text", 
    "text": "Error: å‚æ•° 'analysis_params' éªŒè¯å¤±è´¥:\n  â€¢ n_pcs: å€¼å¿…é¡»å¤§äº 0ï¼Œå½“å‰å€¼: -5"
  }],
  "isError": true
}
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç»•è¿‡ FastMCP è‡ªåŠ¨éªŒè¯
- **é—®é¢˜**: FastMCP åœ¨è°ƒç”¨å·¥å…·å‡½æ•°ä¹‹å‰è‡ªåŠ¨éªŒè¯ Pydantic æ¨¡å‹
- **è§£å†³**: å°†å‚æ•°ç±»å‹æ”¹ä¸º `Any`ï¼Œä½¿ç”¨è‡ªå®šä¹‰éªŒè¯è£…é¥°å™¨

### 2. æ‰‹åŠ¨å‚æ•°éªŒè¯ç³»ç»Ÿ
**æ–‡ä»¶**: `utils/mcp_parameter_handler.py`

```python
@manual_parameter_validation(
    ("params", validate_analysis_params)
)
async def preprocess_data(
    data_id: str,
    params: Any = None,  # ä¸å†ä½¿ç”¨ AnalysisParameters ç±»å‹
    context: Context = None
):
    # params ç°åœ¨æ˜¯ç»è¿‡éªŒè¯çš„ AnalysisParameters å®ä¾‹
    ...
```

### 3. ä¸­æ–‡é”™è¯¯ä¿¡æ¯æ˜ å°„
```python
error_messages = {
    "greater_than": f"'{field_name}' å¿…é¡»å¤§äº {min_value}ï¼Œå½“å‰å€¼: {value}",
    "less_than_equal": f"'{field_name}' å¿…é¡»å°äºç­‰äº {max_value}ï¼Œå½“å‰å€¼: {value}",
    "literal_error": f"'{field_name}' å€¼æ— æ•ˆï¼Œå…è®¸çš„å€¼: {expected}ï¼Œå½“å‰å€¼: {value}",
    # ...
}
```

## ğŸ“ åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶
1. **`utils/mcp_parameter_handler.py`** - æ‰‹åŠ¨å‚æ•°éªŒè¯ç³»ç»Ÿ
2. **`scripts/test_manual_validation.py`** - éªŒè¯ç³»ç»Ÿæµ‹è¯•
3. **`scripts/test_updated_tools.py`** - æ›´æ–°åå·¥å…·æµ‹è¯•

### ä¿®æ”¹æ–‡ä»¶
1. **`server.py`** - æ›´æ–° `preprocess_data` å’Œ `visualize_data` å·¥å…·
2. **`utils/pydantic_error_handler.py`** - è¡¥å……éªŒè¯å·¥å…·ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰

## ğŸ¯ å…³é”®æ”¹è¿›

### ç”¨æˆ·ä½“éªŒ
- âœ… **ä¸­æ–‡é”™è¯¯ä¿¡æ¯**: æ›´å®¹æ˜“ç†è§£
- âœ… **è¯¦ç»†é”™è¯¯è¯´æ˜**: åŒ…å«æœŸæœ›å€¼å’Œå®é™…å€¼
- âœ… **MCP å…¼å®¹æ ¼å¼**: LLM å¯ä»¥çœ‹åˆ°å¹¶å¤„ç†é”™è¯¯

### æŠ€æœ¯ä¼˜åŠ¿
- âœ… **ç»•è¿‡æ¡†æ¶é™åˆ¶**: ä¸ä¾èµ– FastMCP çš„è‡ªåŠ¨éªŒè¯
- âœ… **çµæ´»çš„éªŒè¯é€»è¾‘**: å¯ä»¥è‡ªå®šä¹‰éªŒè¯è§„åˆ™
- âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½

### é”™è¯¯å¤„ç†æ”¹è¿›
```python
# ä¹‹å‰ï¼šæŠ›å‡ºå¼‚å¸¸
raise ValidationError("Input should be greater than 0")

# ç°åœ¨ï¼šè¿”å› MCP å…¼å®¹é”™è¯¯
return {
    "content": [{
        "type": "text",
        "text": "Error: å‚æ•° 'n_pcs' éªŒè¯å¤±è´¥:\n  â€¢ n_pcs: å€¼å¿…é¡»å¤§äº 0ï¼Œå½“å‰å€¼: -5"
    }],
    "isError": true
}
```

## ğŸš€ åº”ç”¨åˆ°å…¶ä»–å·¥å…·

å…¶ä»–å·¥å…·å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ¨¡å¼ï¼š

```python
# 1. å¯¼å…¥éªŒè¯å™¨
from .utils.mcp_parameter_handler import manual_parameter_validation, validate_xxx_params

# 2. æ›´æ–°å·¥å…·å®šä¹‰
@mcp.tool()
@mcp_tool_error_handler()
@manual_parameter_validation(("params", validate_xxx_params))
async def my_tool(data_id: str, params: Any = None):
    # params ç°åœ¨æ˜¯éªŒè¯è¿‡çš„æ¨¡å‹å®ä¾‹
    ...
```

## ğŸ“ˆ æ•°æ®å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| å‚æ•°éªŒè¯é”™è¯¯æ ¼å¼ | ToolError å¼‚å¸¸ | MCP å…¼å®¹æ ¼å¼ | âœ… 100% |
| é”™è¯¯ä¿¡æ¯è¯­è¨€ | è‹±æ–‡æŠ€æœ¯æœ¯è¯­ | ä¸­æ–‡ç”¨æˆ·å‹å¥½ | âœ… 100% |
| LLM å¯è§æ€§ | âŒ çœ‹ä¸åˆ°é”™è¯¯ | âœ… å®Œå…¨å¯è§ | âœ… 100% |
| è°ƒè¯•ä¿¡æ¯ | å †æ ˆè·Ÿè¸ª | æ¸…æ™°å‚æ•°è¯´æ˜ | âœ… æå‡ |

## âœ… ç»“è®º

**é«˜ä¼˜å…ˆçº§çš„ Pydantic éªŒè¯é—®é¢˜å·²ç»å®Œå…¨è§£å†³**ï¼

### ä¸»è¦æˆå°±
1. **ç”¨æˆ·ä¸å†é‡åˆ° ToolError å¼‚å¸¸**
2. **å‚æ•°é”™è¯¯ç°åœ¨è¿”å›æ¸…æ™°çš„ä¸­æ–‡è¯´æ˜**
3. **LLM å¯ä»¥çœ‹åˆ°å¹¶ç†è§£å‚æ•°é”™è¯¯**
4. **é”™è¯¯æ ¼å¼å®Œå…¨ç¬¦åˆ MCP è§„èŒƒ**

### å‰©ä½™å·¥ä½œ
- ğŸŸ¡ Context é”™è¯¯ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰- ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
- ğŸŸ¢ å°†è§£å†³æ–¹æ¡ˆåº”ç”¨åˆ°æ›´å¤šå·¥å…·ï¼ˆå¯é€‰ï¼‰

è¿™æ˜¯ä¸€ä¸ª**é‡å¤§æ”¹è¿›**ï¼Œæ˜¾è‘—æå‡äº† ChatSpatial MCP æœåŠ¡å™¨çš„ç”¨æˆ·ä½“éªŒå’Œ LLM äº¤äº’è´¨é‡ï¼